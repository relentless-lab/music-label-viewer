<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>音乐标注任务播放器</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px 80px;
      line-height: 1.6;
      background: #fafafa;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 8px;
    }
    .top-bar {
      margin-bottom: 12px;
      font-size: 14px;
    }
    .top-bar input {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      min-width: 160px;
    }
    .pack-info {
      margin-bottom: 24px;
      padding: 12px 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      font-size: 14px;
    }
    .clip-card {
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      background: #fff;
    }
    .clip-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 16px;
    }
    .clip-id {
      font-size: 14px;
      margin-bottom: 6px;
    }
    audio {
      width: 100%;
      margin: 8px 0 12px;
    }
    code {
      background: #f0f0f0;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 90%;
    }
    .hint {
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
    }
    .field-group {
      margin: 10px 0;
      font-size: 13px;
    }
    .field-label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .field-group label {
      white-space: nowrap;
      font-size: 13px;
    }
    .option-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      margin-top: 4px;
    }
    .sub-label {
      margin-top: 6px;
      font-size: 12px;
      color: #666;
    }
    textarea {
      width: 100%;
      min-height: 50px;
      resize: vertical;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    .export-box {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(250,250,250,0.96);
      border-top: 1px solid #e3e3e3;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .export-box strong {
      color: #222;
    }
    button.primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    button.primary:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .error {
      color: #c00;
      font-weight: bold;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h1>音乐标注任务播放器</h1>

  <div class="top-bar">
    标注人编号 / 昵称：
    <input id="annotatorInput" placeholder="A01 / 小王 等" />
  </div>

  <div id="app">正在加载任务……</div>

  <div class="export-box" id="exportBox" style="display:none;">
    <div>
      <div>当前任务包：<strong id="packIdLabel"></strong></div>
      <div>说明：每条 clip 的「情绪（1~2 个）+ 场景 + 乐器 + 节奏」为必填，全部填完再提交。</div>
    </div>
    <button class="primary" id="exportBtn">提交本包标注</button>
  </div>

  <script>
    // ====== 配置 ======
    const BASE_AUDIO_URL = "https://music-clips-jp.oss-cn-shenzhen.aliyuncs.com/audio";
    const PACKS_JSON_URL = "packs.json";

    const SUPABASE_URL = "https://mbpdyscamzjyknpnmidw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1icGR5c2NhbXpqeWtucG5taWR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTI4NjcsImV4cCI6MjA3OTg2ODg2N30.SIbSn-YtTsTYwpEYnepswgNrTxwMfE8cr55I0I04ydw";
    // ==================

    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const packId = getParam("pack") || "1";
    const token = getParam("token") || "";
    const annotatorFromUrl = getParam("annotator") || "";

    const app = document.getElementById("app");
    const exportBox = document.getElementById("exportBox");
    const packIdLabel = document.getElementById("packIdLabel");
    const exportBtn = document.getElementById("exportBtn");
    const annotatorInput = document.getElementById("annotatorInput");

    if (annotatorFromUrl) {
      annotatorInput.value = annotatorFromUrl;
    }

    let currentClips = [];

    // 给每个情绪组加“最多 2 个”的前端限制
    function setupMoodLimit() {
      currentClips.forEach(clip => {
        const moodName = `mood_${clip.clip_id}`;
        const boxes = Array.from(document.querySelectorAll(`input[name="${moodName}"]`));
        boxes.forEach(box => {
          box.addEventListener("change", () => {
            const checked = boxes.filter(b => b.checked);
            if (checked.length > 2) {
              box.checked = false;
              alert("整体情绪最多选择 2 个，请取消一个再选。");
            }
          });
        });
      });
    }

    // 加载 packs.json 并渲染
    fetch(PACKS_JSON_URL)
      .then(resp => resp.json())
      .then(data => {
        const packs = data.packs || {};
        const clips = packs[String(packId)];

        if (!clips || clips.length === 0) {
          app.innerHTML = `<p class="error">找不到 pack_id = ${packId} 对应的 clip 列表。</p>`;
          return;
        }

        currentClips = clips.slice().sort((a, b) => a.order_in_pack - b.order_in_pack);
        packIdLabel.textContent = packId;
        exportBox.style.display = "flex";

        let html = `
          <div class="pack-info">
            <p>当前任务包编号：<strong>${packId}</strong> （本包共有 ${currentClips.length} 条 clip，建议全部标完）</p>
            <p>操作说明：</p>
            <ul>
              <li>按顺序播放每一条音频。</li>
              <li>为每条 clip 选择 1~2 个整体情绪、若干场景标签、若干乐器标签、1 个节奏，并可填写一句话描述。</li>
              <li><strong>情绪（1~2 个）+ 场景 + 乐器 + 节奏为必填</strong>，否则无法提交。</li>
            </ul>
          </div>
        `;

        currentClips.forEach((clip, idx) => {
          const clipId = clip.clip_id;
          const fileName = clip.file_name;
          const audioUrl = BASE_AUDIO_URL.replace(/\/$/, "") + "/" + fileName;

          const moodName  = `mood_${clipId}`;
          const tempoName = `tempo_${clipId}`;
          const sceneName = `scene_${clipId}`;
          const instName  = `inst_${clipId}`;
          const noteId    = `note_${clipId}`;

          html += `
            <div class="clip-card">
              <div class="clip-title">Clip ${idx + 1} / ${currentClips.length}</div>
              <div class="clip-id">clip_id：<code>${clipId}</code></div>
              <audio controls src="${audioUrl}">
                您的浏览器不支持 audio 标签。
              </audio>
              <div class="hint">
                系统会自动记录该 clip 的标注，请专注于听感和填写即可。
              </div>

              <!-- 情绪 -->
              <div class="field-group">
                <div class="field-label">1）整体情绪（多选，1~2 个，必选）</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${moodName}" value="bright_daily"> 明亮/日常</label>
                  <label><input type="checkbox" name="${moodName}" value="anime_youth"> 日漫/青春</label>
                  <label><input type="checkbox" name="${moodName}" value="sad"> 伤感/忧郁</label>
                  <label><input type="checkbox" name="${moodName}" value="healing_up"> 治愈/向上</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${moodName}" value="calm_warm"> 平静/温柔</label>
                  <label><input type="checkbox" name="${moodName}" value="epic_fate"> 宿命/史诗感</label>
                  <label><input type="checkbox" name="${moodName}" value="hot_blood"> 热血/高昂</label>
                  <label><input type="checkbox" name="${moodName}" value="tension_battle"> 紧张/战斗</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${moodName}" value="mysterious"> 神秘/奇异</label>
                  <label><input type="checkbox" name="${moodName}" value="dark_hopeless"> 黑暗/绝望</label>
                  <label><input type="checkbox" name="${moodName}" value="comedy"> 搞笑/沙雕</label>
                  <label><input type="checkbox" name="${moodName}" value="other"> 其他/难以判断</label>
                </div>
              </div>

              <!-- 节奏 -->
              <div class="field-group">
                <div class="field-label">2）节奏感（单选，必选）</div>
                <div class="option-row">
                  <label><input type="radio" name="${tempoName}" value="slow"> 慢（偏抒情/舒缓）</label>
                  <label><input type="radio" name="${tempoName}" value="medium"> 中（常规中速）</label>
                  <label><input type="radio" name="${tempoName}" value="fast"> 快（偏快/高节奏）</label>
                </div>
              </div>

              <!-- 场景：按类别分组 -->
              <div class="field-group">
                <div class="field-label">3）画面场景（多选，至少 1 个）</div>

                <div class="sub-label">日常地点</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="school_class"> 校园/教室</label>
                  <label><input type="checkbox" name="${sceneName}" value="after_school_club"> 放学/社团活动</label>
                  <label><input type="checkbox" name="${sceneName}" value="anime_rooftop"> 学校天台</label>
                  <label><input type="checkbox" name="${sceneName}" value="city_street_day"> 白天城市街道</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="city_street_night"> 夜晚霓虹街道</label>
                  <label><input type="checkbox" name="${sceneName}" value="train_commute"> 电车/地铁通勤</label>
                  <label><input type="checkbox" name="${sceneName}" value="anime_rail_crossing"> 铁路道口/平交道</label>
                  <label><input type="checkbox" name="${sceneName}" value="room_alone"> 室内/自己房间</label>
                </div>

                <div class="sub-label">剧情 / 情感</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="confession_date"> 告白/约会</label>
                  <label><input type="checkbox" name="${sceneName}" value="reminiscence_flashback"> 回忆/回想场景</label>
                  <label><input type="checkbox" name="${sceneName}" value="farewell"> 告别/离别</label>
                  <label><input type="checkbox" name="${sceneName}" value="everyday_montage"> 日常蒙太奇</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="anime_op_ed"> 日漫 OP/ED 镜头感</label>
                </div>

                <div class="sub-label">季节 / 天气 / 自然</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="spring_cherry"> 春天/樱花/入学</label>
                  <label><input type="checkbox" name="${sceneName}" value="summer_holiday"> 夏日/暑假午后</label>
                  <label><input type="checkbox" name="${sceneName}" value="summer_festival"> 夏日祭/烟花大会</label>
                  <label><input type="checkbox" name="${sceneName}" value="autumn_leaves"> 秋天/枫叶</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="rainy_city"> 雨天/打伞行走</label>
                  <label><input type="checkbox" name="${sceneName}" value="snow_scene"> 雪景/冬日</label>
                  <label><input type="checkbox" name="${sceneName}" value="nature_field"> 草地/森林/山/河</label>
                  <label><input type="checkbox" name="${sceneName}" value="sea_beach"> 海边/沙滩</label>
                </div>

                <div class="sub-label">战斗 / 奇幻 / 和风</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="battle_fight"> 战斗/对决</label>
                  <label><input type="checkbox" name="${sceneName}" value="chase_run"> 追逐/疾跑</label>
                  <label><input type="checkbox" name="${sceneName}" value="isekai_fantasy"> 异世界/幻想世界</label>
                  <label><input type="checkbox" name="${sceneName}" value="shrine_temple"> 神社/寺庙/鸟居</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="japanese_old_town"> 和风小镇/古街</label>
                </div>

                <div class="sub-label">其他 / 功能性</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${sceneName}" value="sports"> 体育比赛/竞技</label>
                  <label><input type="checkbox" name="${sceneName}" value="game_ui"> 游戏/菜单/界面 BGM</label>
                  <label><input type="checkbox" name="${sceneName}" value="other"> 其他</label>
                </div>
              </div>

              <!-- 乐器 -->
              <div class="field-group">
                <div class="field-label">4）主要乐器（多选，至少 1 个）</div>
                <div class="sub-label">传统 / Band 配器</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${instName}" value="piano"> 钢琴</label>
                  <label><input type="checkbox" name="${instName}" value="strings"> 弦乐（小提琴/大提琴等）</label>
                  <label><input type="checkbox" name="${instName}" value="acoustic_guitar"> 原声吉他</label>
                  <label><input type="checkbox" name="${instName}" value="electric_guitar"> 电吉他</label>
                </div>
                <div class="option-row">
                  <label><input type="checkbox" name="${instName}" value="bass"> 贝斯</label>
                  <label><input type="checkbox" name="${instName}" value="drums"> 鼓/整套鼓组</label>
                  <label><input type="checkbox" name="${instName}" value="percussion"> 打击乐（铃/木鱼/鼓点等）</label>
                </div>

                <div class="sub-label">电子 / 合成器</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${instName}" value="synth_pad"> 合成器 Pad / 氛围音</label>
                  <label><input type="checkbox" name="${instName}" value="synth_lead"> 电子 Lead / 主旋律</label>
                  <label><input type="checkbox" name="${instName}" value="chiptune_8bit"> 8bit / 游戏芯片音色</label>
                </div>

                <div class="sub-label">管乐 / 和风</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${instName}" value="wind_brass"> 铜管（小号/长号/萨克斯）</label>
                  <label><input type="checkbox" name="${instName}" value="wind_wood"> 木管（长笛/单簧管等）</label>
                  <label><input type="checkbox" name="${instName}" value="jp_traditional"> 和风乐器（三味线/尺八/筝等）</label>
                </div>

                <div class="sub-label">人声 / 其他</div>
                <div class="option-row">
                  <label><input type="checkbox" name="${instName}" value="vocal_lead"> 主唱人声</label>
                  <label><input type="checkbox" name="${instName}" value="chorus"> 合唱/和声</label>
                  <label><input type="checkbox" name="${instName}" value="vocaloid"> 电子人声/Vocaloid 感</label>
                  <label><input type="checkbox" name="${instName}" value="ambient_fx"> 环境音/音效/FX</label>
                  <label><input type="checkbox" name="${instName}" value="other"> 其他</label>
                </div>
              </div>

              <!-- 一句话描述 -->
              <div class="field-group">
                <div class="field-label">5）一句话描述（自由填写，可选）</div>
                <textarea id="${noteId}" placeholder="例如：夏日祭烟花结束后，两个人一起走在河边回家的路上，有一点宿命感但整体偏治愈……"></textarea>
              </div>
            </div>
          `;
        });

        app.innerHTML = html;
        setupMoodLimit(); // 渲染完再挂载“最多 2 个情绪”的逻辑
      })
      .catch(err => {
        console.error(err);
        app.innerHTML = `<p class="error">加载 packs.json 失败，请检查路径和权限。</p>`;
      });

    // 提交：带必填检查（情绪 1~2 个，场景≥1，乐器≥1，节奏必选）
    exportBtn.addEventListener("click", async () => {
      if (!currentClips.length) return;

      const annotator = (annotatorInput.value || "").trim();
      if (!annotator) {
        alert("请先填写上方的编号 / 昵称。");
        annotatorInput.focus();
        return;
      }

      const rows = [];
      const incomplete = []; // 记录没填完整/不合规的 clip 序号

      currentClips.forEach(clip => {
        const clipId = clip.clip_id;
        const moodName  = `mood_${clipId}`;
        const tempoName = `tempo_${clipId}`;
        const sceneName = `scene_${clipId}`;
        const instName  = `inst_${clipId}`;
        const noteId    = `note_${clipId}`;

        const moodEls  = Array.from(document.querySelectorAll(`input[name="${moodName}"]:checked`));
        const sceneEls = Array.from(document.querySelectorAll(`input[name="${sceneName}"]:checked`));
        const instEls  = Array.from(document.querySelectorAll(`input[name="${instName}"]:checked`));
        const tempoEl  = document.querySelector(`input[name="${tempoName}"]:checked`);

        const moodCount = moodEls.length;
        const moods  = moodEls.map(el => el.value).join(";");
        const scenes = sceneEls.map(el => el.value).join(";");
        const insts  = instEls.map(el => el.value).join(";");
        const tempo  = tempoEl ? tempoEl.value : "";

        const note = (document.getElementById(noteId)?.value || "").replace(/\r?\n/g, " ");

        // 必填/数量检查：情绪 1~2 个；场景≥1；乐器≥1；节奏必选
        if (moodCount < 1 || moodCount > 2 || !scenes || !insts || !tempo) {
          incomplete.push(clip.order_in_pack);
        }

        rows.push({
          order_in_pack: clip.order_in_pack,
          clip_id: clipId,
          mood: moods,
          scenes: scenes,
          instruments: insts,
          tempo: tempo,
          note: note
        });
      });

      if (incomplete.length > 0) {
        alert(
          "还有这些 clip 没填完整或情绪选择超过 2 个：\n\n" +
          incomplete.join(", ") +
          "\n\n每条 clip 需要：\n- 1~2 个情绪\n- ≥1 个场景\n- ≥1 个乐器\n- 1 个节奏\n请补全后再提交。"
        );
        return;
      }

      if (!rows.length) {
        alert("没有收集到任何答案，请先完成本页的标注。");
        return;
      }

      exportBtn.disabled = true;
      exportBtn.textContent = "提交中…";

      try {
        const now = new Date().toISOString();

        // 1) 写 labels 表
        const labelRows = rows.map(r => ({
          created_at: now,          // 如果 labels 表是 created_at，就改成 created_at: now
          annotator: annotator,
          pack_id: packId,
          order_in_pack: r.order_in_pack,
          clip_id: r.clip_id,
          mood: r.mood || "",
          scenes: r.scenes || "",
          instruments: r.instruments || "",
          tempo: r.tempo || "",
          note: r.note || ""
        }));

        const resp1 = await fetch(`${SUPABASE_URL}/rest/v1/labels`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify(labelRows)
        });
        if (!resp1.ok) {
          const t = await resp1.text();
          console.error("labels error:", t);
          throw new Error("写 labels 失败");
        }

        // 2) 根据 token 把 assignments.done 标为 true
        if (token) {
          const resp2 = await fetch(
            `${SUPABASE_URL}/rest/v1/assignments?token=eq.${encodeURIComponent(token)}`,
            {
              method: "PATCH",
              headers: {
                apikey: SUPABASE_ANON_KEY,
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                "Content-Type": "application/json",
                Prefer: "return=minimal"
              },
              body: JSON.stringify({ done: true })
            }
          );
          if (!resp2.ok) {
            const t2 = await resp2.text();
            console.error("assignments error:", t2);
          }
        }

        alert("提交成功！本包共提交 " + rows.length + " 条标注，感谢你的参与。");
      } catch (err) {
        console.error(err);
        alert("提交失败，请截图并联系任务发起人，可以稍后重试一次。");
      } finally {
        exportBtn.disabled = false;
        exportBtn.textContent = "提交本包标注";
      }
    });
  </script>
</body>
</html>
